<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SHAKOM PS - Cache</title>
    <script src="./bundle.js"></script>
    <style>
      html,body{height:100%;margin:0}
      body {
        /* centered background that scrolls with page */
        background: url('./imgg.jpg') no-repeat center center;
        background-size: cover;
        background-color: #252526; /* fallback color if image fails */
        font-family: sans-serif;
      }
      h2 {
        margin-bottom: 20px;
        color: #ffffff;
        text-align: center;
        padding-top: 20px;
      }
      #console {
        font-family: monospace;
        background-color: rgba(30,30,30,0.85);
        color: #cccccc;
        border: 1px solid #3c3c3c;
        padding: 12px;
        border-radius: 6px;
        margin: 20px auto;
        text-align: left;
        max-width: 900px;
        white-space: pre-wrap;
      }
      /* Hide the button on cached page too */
      #jailbreakBtn { display: none; }
      footer {
        margin-top: 30px;
        font-size: 14px;
        color: #888;
        text-align: center;
      }
      a { color: #aaa; }
      .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>SHAKOM PS (Cache)</h2>

      <div>
        <button id="jailbreakBtn">اضغط هنا لتفعيل التعديل</button>
      </div>
      <pre id="console"></pre>

      <footer>
        <p>You are viewing the cached page.</p>
        <p><a href="index.html">Return to live page</a></p>
      </footer>
    </div>
  </body>

  <!-- Register the service worker (place this after the DOM or before inline script) -->
  <script>
    (function(){
      const outputConsole = document.getElementById("console");
      window.log = (msg, color="#cccccc") => {
        if (outputConsole) {
          outputConsole.innerHTML += `<span style="color:${color}">${msg}</span><br>`;
        } else {
          console.log(msg);
        }
      };

      const CACHE_NAME = 'shakomps-cache-v1';
      const ASSETS_TO_CACHE = [
        './cache.html',
        './bundle.js',
        './imgg.jpg',
        '../index.html'
      ];

      // Helper: download assets into the cache from the page (proactive caching)
      function downloadCache() {
        if (!('caches' in window)) {
          window.log('Cache API not supported in this browser; cannot download cache proactively.', 'orange');
          return Promise.resolve();
        }
        window.log('Starting proactive caching of assets...', '#aaffaa');
        return caches.open(CACHE_NAME).then(cache => {
          return cache.addAll(ASSETS_TO_CACHE.map(p => new Request(p, { cache: 'reload' })))
            .then(() => {
              window.log('Assets successfully cached: ' + ASSETS_TO_CACHE.join(', '), '#aaffaa');
            })
            .catch(err => {
              window.log('Error while caching assets: ' + err, 'red');
              // fallback: try caching each resource individually so some can succeed
              return Promise.all(ASSETS_TO_CACHE.map(p => cache.add(p).catch(e => {
                window.log('Failed to cache ' + p + ': ' + e, 'orange');
              })));
            });
        }).catch(err => {
          window.log('Could not open cache: ' + err, 'orange');
        });
      }

      // Service worker registration and proactive cache trigger
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => {
            window.log('Service Worker registered (scope: ' + reg.scope + ')', '#aaffaa');

            // If the SW is active, proactively download the cache immediately.
            // If SW is installing/waiting, still attempt to cache from the page (Cache API is available to pages too).
            downloadCache();

            // Also listen for updates from SW (optional): when SW claims clients it may update resources.
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              window.log('Service Worker controller changed.', '#aaffaa');
            });
          })
          .catch(err => {
            window.log('Service Worker registration failed: ' + err, 'orange');
            // Still attempt to cache even if SW registration failed (Cache API available to page)
            downloadCache();
          });
      } else {
        window.log('Service Worker not supported in this browser. Attempting to cache using Cache API directly.', 'orange');
        downloadCache();
      }

      // Auto-run exploit when DOM is ready (same logic as before),
      // but more defensive and with clearer offline message.
      document.addEventListener('DOMContentLoaded', () => {
        // clear console display area (keeps SW messages visible)
        if (outputConsole) outputConsole.textContent = "";
        try {
          if (typeof doJBwithPSFreeLapseExploit === 'function') {
            window.log('Starting automatic exploit (cached page)...', '#aaffaa');
            doJBwithPSFreeLapseExploit();
          } else {
            window.log('Exploit function not available on load (cached page). Waiting for bundle...', 'orange');
            let attempts = 0;
            const maxAttempts = 20;
            const id = setInterval(() => {
              attempts++;
              if (typeof doJBwithPSFreeLapseExploit === 'function') {
                clearInterval(id);
                window.log('Exploit function found — running now.', '#aaffaa');
                try { doJBwithPSFreeLapseExploit(); } catch (e) { window.log('Error running exploit: ' + e, 'red'); }
              } else if (attempts >= maxAttempts) {
                clearInterval(id);
                if (!navigator.onLine) {
                  window.log('Still offline — bundle.js not available and exploit could not be loaded.', 'orange');
                  window.log('If you want the bundle available offline, make sure the service worker is installed and cached the bundle.', 'orange');
                } else {
                  window.log('Exploit function did not appear after waiting. Bundle might be missing or failed to run.', 'orange');
                }
              }
            }, 250);
          }
        } catch (error) {
          window.log("An error occured during exploit: " + error, "red");
        }
      });
    })();
  </script>
</html>
